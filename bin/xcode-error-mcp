#!/usr/bin/env node
'use strict';

const fs = require('fs');
const path = require('path');
const { spawn } = require('child_process');

const packageRoot = path.resolve(__dirname, '..');
const binaryPath = path.join(packageRoot, '.build', 'release', 'xcode-error-mcp');

function isExecutable(filePath) {
  try {
    fs.accessSync(filePath, fs.constants.X_OK);
    return true;
  } catch {
    return false;
  }
}

if (!isExecutable(binaryPath)) {
  process.stderr.write(
    `xcode-error-mcp: binary not found (or not executable): ${binaryPath}\n` +
      'Reinstall without --ignore-scripts, or run:\n' +
      `  npm run build --prefix "${packageRoot}"\n`
  );
  process.exit(1);
}

const child = spawn(binaryPath, process.argv.slice(2), { stdio: 'inherit' });

process.on('SIGINT', () => child.kill('SIGINT'));
process.on('SIGTERM', () => child.kill('SIGTERM'));

child.on('error', (err) => {
  process.stderr.write(`xcode-error-mcp: failed to launch: ${err.message}\n`);
  process.exit(1);
});

child.on('exit', (code) => {
  process.exit(code ?? 1);
});

